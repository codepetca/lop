<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SvelteKit + PartyKit Tutorial</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8fafc;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
            gap: 0;
        }

        .sidebar {
            background: #1e293b;
            color: white;
            padding: 2rem 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar h2 {
            color: #f1f5f9;
            margin: 0 2rem 1.5rem 2rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .step-list {
            list-style: none;
        }

        .step-item {
            margin-bottom: 0.5rem;
        }

        .step-link {
            display: block;
            padding: 0.75rem 2rem;
            color: #cbd5e1;
            background: none;
            border: none;
            text-align: left;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-family: inherit;
            font-size: inherit;
        }

        .step-link:hover {
            background: #334155;
            color: white;
            border-left-color: #6366f1;
        }

        .step-link.active {
            background: #334155;
            color: white;
            border-left-color: #6366f1;
            font-weight: 600;
        }

        .main-content {
            background: white;
            min-height: 100vh;
        }

        .content-wrapper {
            padding: 3rem;
            max-width: 800px;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        h1 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 2.5rem;
            font-weight: 700;
        }

        h2 {
            color: #1e293b;
            margin: 2rem 0 1rem 0;
            font-size: 1.75rem;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }

        h3 {
            color: #374151;
            margin: 1.5rem 0 0.75rem 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        p {
            margin-bottom: 1rem;
            color: #4b5563;
        }

        .intro {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .intro h1 {
            color: white;
            margin-bottom: 1rem;
        }

        .intro p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
        }

        pre {
            background: #1e293b;
            color: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        code {
            background: #e2e8f0;
            color: #1e293b;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        pre code {
            background: transparent;
            color: inherit;
            padding: 0;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #e2e8f0;
        }

        .nav-btn {
            background: #6366f1;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-block;
        }

        .nav-btn:hover {
            background: #4f46e5;
        }

        .nav-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .nav-btn.secondary {
            background: #e2e8f0;
            color: #374151;
        }

        .nav-btn.secondary:hover {
            background: #cbd5e1;
        }

        .warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .step-number {
            background: #6366f1;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 0.5rem;
            margin-bottom: 1rem;
        }

        ul,
        ol {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        li {
            margin-bottom: 0.5rem;
            color: #4b5563;
        }

        @media (max-width: 768px) {
            .content-wrapper {
                padding: 2rem 1rem;
            }

            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <nav class="sidebar">
            <h2>Tutorial Steps</h2>
            <ul class="step-list">
                <li class="step-item">
                    <button class="step-link" data-step="0">
                        <span class="step-number">0</span>Introduction
                    </button>
                </li>
                <li class="step-item">
                    <button class="step-link" data-step="1">
                        <span class="step-number">1</span>Project Setup
                    </button>
                </li>
                <li class="step-item">
                    <button class="step-link" data-step="2">
                        <span class="step-number">2</span>TypeScript Types
                    </button>
                </li>
                <li class="step-item">
                    <button class="step-link" data-step="3">
                        <span class="step-number">3</span>PartyKit Server
                    </button>
                </li>
                <li class="step-item">
                    <button class="step-link" data-step="4">
                        <span class="step-number">4</span>Home Page Setup
                    </button>
                </li>
                <li class="step-item">
                    <button class="step-link" data-step="5">
                        <span class="step-number">5</span>Poll Creation Form
                    </button>
                </li>
                <li class="step-item">
                    <button class="step-link" data-step="6">
                        <span class="step-number">6</span>Poll Page Setup
                    </button>
                </li>
                <li class="step-item">
                    <button class="step-link" data-step="7">
                        <span class="step-number">7</span>Real-time Voting
                    </button>
                </li>
                <li class="step-item">
                    <button class="step-link" data-step="8">
                        <span class="step-number">8</span>Running the App
                    </button>
                </li>
                <li class="step-item">
                    <button class="step-link" data-step="9">
                        <span class="step-number">9</span>Deployment
                    </button>
                </li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="content-wrapper">
                <!-- Step 0: Introduction -->
                <div class="step-content active" id="step-0">
                    <div class="intro">
                        <h1>SvelteKit + PartyKit Real-Time Polling App</h1>
                        <p>Build a real-time multiplayer polling app with live updates, vote persistence, and seamless
                            user experience. Perfect for learning real-time web development!</p>
                    </div>

                    <!-- Navigation -->
                    <div class="navigation">
                        <button class="nav-btn secondary" onclick="previousStep()">← Previous</button>
                        <span>Step 1 of 10</span>
                        <button class="nav-btn" onclick="nextStep()">Next →</button>
                    </div>
                </div>

                <!-- Step 1: Project Setup -->
                <div class="step-content" id="step-1">
    <h1>Step 1: Project Setup</h1>
    <p>Let's start by creating a new SvelteKit project and installing the necessary dependencies for our real-time
        polling app.</p>

    <h2>Create SvelteKit Project</h2>
    <p>First, we'll create a new SvelteKit project using the latest CLI:</p>
    <pre><code>npx sv create easypoll
cd easypoll
npm install</code></pre>

    <p>When prompted, choose these options:</p>
    <ul>
        <li><strong>Template:</strong> Skeleton project</li>
        <li><strong>Add type checking with TypeScript:</strong> Yes</li>
        <li><strong>Add ESLint for code linting:</strong> Yes (recommended)</li>
        <li><strong>Add Prettier for code formatting:</strong> Yes (recommended)</li>
    </ul>

    <h2>Install Dependencies</h2>
    <p>Now let's install PartyKit and the additional dependencies we'll need:</p>
    <pre><code>npm install partykit partysocket
npm install -D @types/node</code></pre>

    <h2>Create Environment Variables</h2>
    <p>Create a <code>.env</code> file in your project root with the following content:</p>
    <pre><code># Development
PARTYKIT_URL=http://127.0.0.1:1999
PUBLIC_PARTYKIT_HOST=127.0.0.1:1999

# Production (set when deploying)
# PUBLIC_PARTYKIT_HOST=your-project.your-username.partykit.dev</code></pre>

    <h2>Configure PartyKit</h2>
    <p>Create a <code>partykit.json</code> file in your project root:</p>
    <pre><code>{
  "name": "easypoll",
  "main": "party/index.ts",
  "compatibilityDate": "2025-07-15"
}</code></pre>

                    <div class="success">
                        <strong>✅ Great job!</strong> Your project structure is now set up and ready for development. In the next step,
                        we'll create the TypeScript types that will be shared between our client and server code.
                    </div>

                    <!-- Navigation -->
                    <div class="navigation">
                        <button class="nav-btn secondary" onclick="previousStep()">← Previous</button>
                        <span>Step 2 of 10</span>
                        <button class="nav-btn" onclick="nextStep()">Next →</button>
                    </div>
                </div>

                <!-- Step 2: TypeScript Types -->
                <div class="step-content" id="step-2">
    <div class="step-number">2</div>
    <h1>Step 2: TypeScript Types</h1>
    <p>Let's create the TypeScript interfaces that will define the structure of our data throughout the application.</p>

    <h2>Create the Types File</h2>
    <p>First, create the <code>src/lib</code> directory if it doesn't exist:</p>
    <pre><code>mkdir src/lib</code></pre>

    <p>Now create <code>src/lib/types.ts</code> with the following content:</p>
    <pre><code>export interface Poll {
  id: string;
  title: string;
  options: string[];
  votes: { [option: string]: number };
}

export interface VoteMessage {
  type: 'vote';
  option: string;
}

export interface PollUpdateMessage {
  type: 'poll-update';
  poll: Poll;
}

export type Message = VoteMessage | PollUpdateMessage;</code></pre>

    <h2>Understanding the Types</h2>
    <p>Let's break down what each interface does:</p>

    <h3>Poll Interface</h3>
    <ul>
        <li><strong>id:</strong> Unique identifier for each poll</li>
        <li><strong>title:</strong> The question being asked</li>
        <li><strong>options:</strong> Array of possible answers</li>
        <li><strong>votes:</strong> Object mapping each option to its vote count</li>
    </ul>

    <h3>Message Types</h3>
    <ul>
        <li><strong>VoteMessage:</strong> Sent when a user votes for an option</li>
        <li><strong>PollUpdateMessage:</strong> Sent to update all clients with new vote counts</li>
        <li><strong>Message:</strong> Union type for type-safe message handling</li>
    </ul>

    <div class="warning">
        <strong>💡 Pro Tip:</strong> Having shared types between client and server ensures consistency and catches
        errors at compile time rather than runtime.
    </div>

                    <div class="success">
                        <strong>✅ Types Created!</strong> Now we have a solid foundation for type-safe development. Next, we'll create
                        the PartyKit server that will handle our real-time functionality.
                    </div>

                    <!-- Navigation -->
                    <div class="navigation">
                        <button class="nav-btn secondary" onclick="previousStep()">← Previous</button>
                        <span>Step 3 of 10</span>
                        <button class="nav-btn" onclick="nextStep()">Next →</button>
                    </div>
                </div>

                <!-- Step 3: PartyKit Server -->
                <div class="step-content" id="step-3">
    <div class="step-number">3</div>
    <h1>Step 3: PartyKit Server</h1>
    <p>Now we'll create the PartyKit server that handles real-time communication, vote processing, and data persistence.
    </p>

    <h2>Create the Server Directory</h2>
    <p>First, create the <code>party</code> directory in your project root:</p>
    <pre><code>mkdir party</code></pre>

    <h2>Create the Server File</h2>
    <p>Create <code>party/index.ts</code> with the following content:</p>
    <pre><code>import type * as Party from "partykit/server";

// Types (same as in our SvelteKit app)
interface Poll {
  id: string;
  title: string;
  options: string[];
  votes: { [option: string]: number };
}

interface VoteMessage {
  type: 'vote';
  option: string;
}

interface PollUpdateMessage {
  type: 'poll-update';
  poll: Poll;
}

type Message = VoteMessage | PollUpdateMessage;

export default class PollServer implements Party.Server {
  constructor(readonly room: Party.Room) {}

  // Store poll data in memory
  poll: Poll | null = null;

  // Load poll data from storage when the room starts
  async onStart() {
    const storedPoll = await this.room.storage.get&lt;Poll&gt;("poll");
    if (storedPoll) {
      this.poll = storedPoll;
    }
  }

  // Handle new WebSocket connections
  async onConnect(conn: Party.Connection, ctx: Party.ConnectionContext) {
    // Send current poll data to new connections
    if (this.poll) {
      conn.send(JSON.stringify({
        type: 'poll-update',
        poll: this.poll
      } as PollUpdateMessage));
    }
  }

  // Handle incoming WebSocket messages
  async onMessage(message: string, sender: Party.Connection) {
    try {
      const data = JSON.parse(message) as Message;
      
      if (data.type === 'vote' && this.poll) {
        // Process the vote
        if (this.poll.options.includes(data.option)) {
          this.poll.votes[data.option] = (this.poll.votes[data.option] || 0) + 1;
          
          // Save updated poll to storage
          await this.savePoll();
          
          // Broadcast updated poll to all connected clients
          this.room.broadcast(JSON.stringify({
            type: 'poll-update',
            poll: this.poll
          } as PollUpdateMessage));
        }
      }
    } catch (error) {
      console.error('Error processing message:', error);
    }
  }

  // Handle HTTP requests (for creating polls)
  async onRequest(req: Party.Request): Promise&lt;Response&gt; {
    if (req.method === "POST") {
      try {
        const data = await req.json() as any;
        
        // Validate incoming data
        if (!data || typeof data !== 'object') {
          return new Response("Invalid data format", { status: 400 });
        }
        
        const title = data.title || "Anonymous poll";
        const options = Array.isArray(data.options) ? data.options : [];
        
        // Validate options
        if (options.length &lt; 2) {
          return new Response("At least 2 options required", { status: 400 });
        }
        
        // Create new poll
        const poll: Poll = {
          id: this.room.id,
          title: title,
          options: options,
          votes: {}
        };
        
        // Initialize votes for each option
        options.forEach((option: string) =&gt; {
          poll.votes[option] = 0;
        });
        
        this.poll = poll;
        await this.savePoll();
        
        return new Response(JSON.stringify(poll), {
          headers: { "Content-Type": "application/json" }
        });
      } catch (error) {
        return new Response("Bad Request", { status: 400 });
      }
    }
    
    if (req.method === "GET") {
      // Return current poll data
      if (this.poll) {
        return new Response(JSON.stringify(this.poll), {
          headers: { "Content-Type": "application/json" }
        });
      } else {
        return new Response("Not found", { status: 404 });
      }
    }
    
    return new Response("Method not allowed", { status: 405 });
  }

  // Helper method to save poll to storage
  private async savePoll() {
    if (this.poll) {
      await this.room.storage.put("poll", this.poll);
    }
  }
}

PollServer satisfies Party.Worker;</code></pre>

    <h2>Understanding the Server</h2>
    <p>The PartyKit server handles several key responsibilities:</p>

    <h3>🔌 Connection Management</h3>
    <ul>
        <li><strong>onConnect:</strong> Sends current poll data to new connections</li>
        <li><strong>onMessage:</strong> Processes votes and broadcasts updates</li>
    </ul>

    <h3>🌐 HTTP Endpoints</h3>
    <ul>
        <li><strong>POST:</strong> Creates new polls with validation</li>
        <li><strong>GET:</strong> Retrieves existing poll data</li>
    </ul>

    <h3>💾 Data Persistence</h3>
    <ul>
        <li><strong>onStart:</strong> Loads saved poll data on server restart</li>
        <li><strong>savePoll:</strong> Persists vote updates to storage</li>
    </ul>

                    <div class="success">
                        <strong>✅ Server Ready!</strong> Your PartyKit server is now ready to handle real-time polling. Next, we'll
                        create the SvelteKit pages that will interact with this server.
                    </div>

                    <!-- Navigation -->
                    <div class="navigation">
                        <button class="nav-btn secondary" onclick="previousStep()">← Previous</button>
                        <span>Step 4 of 10</span>
                        <button class="nav-btn" onclick="nextStep()">Next →</button>
                    </div>
                </div>

                <!-- Step 4: Home Page Setup -->
                <div class="step-content" id="step-4">
    <div class="step-number">4</div>
    <h1>Step 4: Home Page Setup</h1>
    <p>Now we'll create the server actions that handle poll creation when users submit the form.</p>

    <h2>Create Server Actions</h2>
    <p>Create <code>src/routes/+page.server.ts</code> with the following content:</p>
    <pre><code>import { redirect, fail } from '@sveltejs/kit';
import type { Actions } from '@sveltejs/kit';
import { env } from '$env/dynamic/private';

// Fallback to default development URL if not set
const PARTYKIT_URL = env.PARTYKIT_URL || 'http://127.0.0.1:1999';

export const actions: Actions = {
  createPoll: async ({ request }) => {
    const data = await request.formData();
    const title = data.get('title')?.toString() ?? 'Anonymous poll';
    
    // Get options from form data
    const options: string[] = [];
    let i = 0;
    while (data.has(`option-${i}`)) {
      const option = data.get(`option-${i}`)?.toString();
      if (option && option.trim()) {
        options.push(option.trim());
      }
      i++;
    }
    
    // Ensure we have at least 2 options
    if (options.length < 2) {
      return fail(400, {
        error: 'Please provide at least 2 options'
      });
    }
    
    // Generate a random poll ID
    const pollId = Math.random().toString(36).substr(2, 9);
    
    console.log(`Creating poll with ID: ${pollId}`);
    console.log(`PartyKit URL: ${PARTYKIT_URL}`);
    
    // Create poll on PartyKit server
    const response = await fetch(`${PARTYKIT_URL}/parties/main/${pollId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title,
        options
      })
    });
    
    console.log(`Response status: ${response.status}`);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error(`PartyKit error: ${errorText}`);
      return fail(500, {
        error: 'Failed to create poll. Please try again.'
      });
    }
    
    // Redirect to the poll page
    throw redirect(302, `/${pollId}`);
  }
};</code></pre>

    <h2>Understanding Server Actions</h2>
    <p>This server action handles the poll creation process:</p>

    <h3>📝 Form Processing</h3>
    <ul>
        <li><strong>FormData extraction:</strong> Gets title and options from the form</li>
        <li><strong>Validation:</strong> Ensures at least 2 options are provided</li>
        <li><strong>ID generation:</strong> Creates a unique poll identifier</li>
    </ul>

    <h3>🌐 API Communication</h3>
    <ul>
        <li><strong>HTTP POST:</strong> Sends poll data to PartyKit server</li>
        <li><strong>Error handling:</strong> Returns user-friendly error messages</li>
        <li><strong>Redirect:</strong> Navigates to the new poll page on success</li>
    </ul>

    <div class="warning">
        <strong>🔧 Note:</strong> We use <code>fail()</code> for proper SvelteKit error handling and
        <code>env.dynamic/private</code> for environment variables.
    </div>

                    <div class="success">
                        <strong>✅ Server Actions Ready!</strong> The backend logic for poll creation is complete. Next, we'll create the
                        user-facing form component.
                    </div>

                    <!-- Navigation -->
                    <div class="navigation">
                        <button class="nav-btn secondary" onclick="previousStep()">← Previous</button>
                        <span>Step 5 of 10</span>
                        <button class="nav-btn" onclick="nextStep()">Next →</button>
                    </div>
                </div>

                <!-- Step 5: Poll Creation Form -->
                <div class="step-content" id="step-5">
    <div class="step-number">5</div>
    <h1>Step 5: Poll Creation Form</h1>
    <p>Let's create the interactive form where users can create new polls with multiple options.</p>

    <h2>Replace Home Page Content</h2>
    <p>Replace all content in <code>src/routes/+page.svelte</code> with:</p>
    <pre><code>&lt;script lang="ts"&gt;
  import { enhance } from '$app/forms';
  import type { ActionData } from './$types';
  
  export let form: ActionData;
  
  let options = ['', ''];
  
  function addOption() {
    options = [...options, ''];
  }
  
  function removeOption(index: number) {
    if (options.length &gt; 2) {
      options = options.filter((_, i) =&gt; i !== index);
    }
  }
  
  let loading = false;
&lt;/script&gt;

&lt;svelte:head&gt;
  &lt;title&gt;Create a Poll&lt;/title&gt;
&lt;/svelte:head&gt;

&lt;main class="container"&gt;
  &lt;h1&gt;Create a New Poll&lt;/h1&gt;
  
  &lt;form 
    method="POST" 
    action="?/createPoll"
    use:enhance={() =&gt; {
      loading = true;
      return async ({ update }) =&gt; {
        loading = false;
        await update();
      };
    }}
  &gt;
    &lt;div class="form-group"&gt;
      &lt;label for="title"&gt;Poll Title&lt;/label&gt;
      &lt;input 
        type="text" 
        id="title" 
        name="title" 
        placeholder="What's your question?"
        required
      /&gt;
    &lt;/div&gt;
    
    &lt;div class="form-group"&gt;
      &lt;label&gt;Options&lt;/label&gt;
      {#each options as option, index}
        &lt;div class="option-input"&gt;
          &lt;input 
            type="text" 
            name="option-{index}" 
            placeholder="Option {index + 1}"
            bind:value={options[index]}
            required
          /&gt;
          {#if options.length &gt; 2}
            &lt;button 
              type="button" 
              class="remove-btn"
              on:click={() =&gt; removeOption(index)}
            &gt;
              ×
            &lt;/button&gt;
          {/if}
        &lt;/div&gt;
      {/each}
      
      &lt;button type="button" class="add-option-btn" on:click={addOption}&gt;
        + Add Option
      &lt;/button&gt;
    &lt;/div&gt;
    
    {#if form?.error}
      &lt;div class="error"&gt;
        {form.error}
      &lt;/div&gt;
    {/if}
    
    &lt;button type="submit" class="submit-btn" disabled={loading}&gt;
      {loading ? 'Creating Poll...' : 'Create Poll'}
    &lt;/button&gt;
  &lt;/form&gt;
&lt;/main&gt;

&lt;style&gt;
  .container {
    max-width: 600px;
    margin: 0 auto;
    padding: 2rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  
  h1 {
    color: #333;
    margin-bottom: 2rem;
    text-align: center;
  }
  
  .form-group {
    margin-bottom: 1.5rem;
  }
  
  label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
  }
  
  input[type="text"] {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }
  
  input[type="text"]:focus {
    outline: none;
    border-color: #4f46e5;
  }
  
  .option-input {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .option-input input {
    flex: 1;
  }
  
  .remove-btn {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1.2rem;
    transition: background-color 0.2s;
  }
  
  .remove-btn:hover {
    background: #dc2626;
  }
  
  .add-option-btn {
    background: #f3f4f6;
    color: #374151;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 0.75rem;
    width: 100%;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s;
  }
  
  .add-option-btn:hover {
    background: #e5e7eb;
    border-color: #9ca3af;
  }
  
  .submit-btn {
    background: #4f46e5;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.2s;
  }
  
  .submit-btn:hover:not(:disabled) {
    background: #4338ca;
  }
  
  .submit-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }
  
  .error {
    background: #fef2f2;
    color: #dc2626;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #fecaca;
    margin-bottom: 1rem;
  }
&lt;/style&gt;</code></pre>

    <h2>Form Features</h2>
    <p>This form includes several user-friendly features:</p>

    <h3>✨ Dynamic Options</h3>
    <ul>
        <li><strong>Add options:</strong> Users can add as many poll options as needed</li>
        <li><strong>Remove options:</strong> Delete unwanted options (minimum 2 required)</li>
        <li><strong>Real-time binding:</strong> Form state updates automatically</li>
    </ul>

    <h3>🔄 Progressive Enhancement</h3>
    <ul>
        <li><strong>Works without JS:</strong> Form submission works even if JavaScript fails</li>
        <li><strong>Enhanced with JS:</strong> Better UX with loading states and validation</li>
        <li><strong>Error handling:</strong> Displays server errors nicely</li>
    </ul>

                    <div class="success">
                        <strong>✅ Form Complete!</strong> Users can now create polls with a beautiful, accessible interface. Next, we'll
                        set up the poll viewing page.
                    </div>

                    <!-- Navigation -->
                    <div class="navigation">
                        <button class="nav-btn secondary" onclick="previousStep()">← Previous</button>
                        <span>Step 6 of 10</span>
                        <button class="nav-btn" onclick="nextStep()">Next →</button>
                    </div>
                </div>

                <!-- Step 6: Poll Page Setup -->
                <div class="step-content" id="step-6">
    <div class="step-number">6</div>
    <h1>Step 6: Poll Page Setup</h1>
    <p>Now we'll create the dynamic route that loads and displays individual polls with their current vote counts.</p>

    <h2>Create Dynamic Route</h2>
    <p>First, create the dynamic route directory:</p>
    <pre><code>mkdir src/routes/[poll_id]</code></pre>

    <h2>Create Server Load Function</h2>
    <p>Create <code>src/routes/[poll_id]/+page.server.ts</code>:</p>
    <pre><code>import { error } from '@sveltejs/kit';
import type { Poll } from '$lib/types';
import { env } from '$env/dynamic/private';
import type { PageServerLoad } from './$types';

// Fallback to default development URL if not set
const PARTYKIT_URL = env.PARTYKIT_URL || 'http://127.0.0.1:1999';

export const load: PageServerLoad = async ({ params, fetch }) => {
  const pollId = params.poll_id;
  
  try {
    const response = await fetch(`${PARTYKIT_URL}/parties/main/${pollId}`);
    
    if (!response.ok) {
      if (response.status === 404) {
        throw error(404, 'Poll not found');
      }
      throw error(500, 'Failed to load poll');
    }
    
    const poll: Poll = await response.json();
    
    return {
      poll,
      pollId
    };
  } catch (err) {
    if (err instanceof Response) {
      throw err;
    }
    throw error(500, 'Failed to load poll');
  }
};</code></pre>

    <h2>Understanding Server-Side Loading</h2>
    <p>This load function runs on the server before the page renders:</p>

    <h3>🎯 Benefits of Server Loading</h3>
    <ul>
        <li><strong>SEO friendly:</strong> Search engines can see the poll content</li>
        <li><strong>Faster initial load:</strong> No loading spinner for initial data</li>
        <li><strong>Better reliability:</strong> Server has better network access to PartyKit</li>
    </ul>

    <h3>🔍 Error Handling</h3>
    <ul>
        <li><strong>404 handling:</strong> Shows proper error page if poll doesn't exist</li>
        <li><strong>500 handling:</strong> Graceful degradation for server errors</li>
        <li><strong>Type safety:</strong> Returns properly typed poll data</li>
    </ul>

    <div class="warning">
        <strong>🔧 Note:</strong> We use <code>PageServerLoad</code> instead of <code>PageLoad</code> to ensure this
        runs on the server, not in the browser.
    </div>

                    <div class="success">
                        <strong>✅ Data Loading Ready!</strong> Our polls will now load quickly with all data available immediately.
                        Next, we'll create the interactive voting interface.
                    </div>

                    <!-- Navigation -->
                    <div class="navigation">
                        <button class="nav-btn secondary" onclick="previousStep()">← Previous</button>
                        <span>Step 7 of 10</span>
                        <button class="nav-btn" onclick="nextStep()">Next →</button>
                    </div>
                </div>

                <!-- Step 7: Real-time Voting -->
                <div class="step-content" id="step-7">
    <div class="step-number">7</div>
    <h1>Step 7: Real-time Voting</h1>
    <p>Now for the exciting part - let's create the interactive poll page with real-time voting and live updates!</p>

    <h2>Create Poll Page Component</h2>
    <p>Create <code>src/routes/[poll_id]/+page.svelte</code> with this comprehensive component:</p>
    <pre><code>&lt;script lang="ts"&gt;
  import { onMount, onDestroy } from 'svelte';
  import { browser } from '$app/environment';
  import { PUBLIC_PARTYKIT_HOST } from '$env/static/public';
  import type { PageData } from './$types';
  import type { Poll, Message, VoteMessage, PollUpdateMessage } from '$lib/types';
  
  export let data: PageData;
  
  let poll: Poll = data.poll;
  let socket: WebSocket | null = null;
  let connecting = true;
  let hasVoted = false;
  
  // Calculate total votes
  $: totalVotes = Object.values(poll.votes).reduce((sum, count) =&gt; sum + count, 0);
  
  // Calculate percentages for each option
  $: optionStats = poll.options.map(option =&gt; ({
    option,
    votes: poll.votes[option] || 0,
    percentage: totalVotes &gt; 0 ? ((poll.votes[option] || 0) / totalVotes) * 100 : 0
  }));
  
  function connectToPartyKit() {
    if (!browser) return;
    
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${PUBLIC_PARTYKIT_HOST}/parties/main/${data.pollId}`;
    
    socket = new WebSocket(wsUrl);
    
    socket.onopen = () =&gt; {
      connecting = false;
      console.log('Connected to PartyKit');
    };
    
    socket.onmessage = (event) =&gt; {
      try {
        const message: Message = JSON.parse(event.data);
        
        if (message.type === 'poll-update') {
          poll = message.poll;
        }
      } catch (error) {
        console.error('Error parsing message:', error);
      }
    };
    
    socket.onclose = () =&gt; {
      console.log('Disconnected from PartyKit');
      // Attempt to reconnect after a delay
      setTimeout(connectToPartyKit, 3000);
    };
    
    socket.onerror = (error) =&gt; {
      console.error('WebSocket error:', error);
      connecting = false;
    };
  }
  
  function vote(option: string) {
    if (!socket || socket.readyState !== WebSocket.OPEN || hasVoted) return;
    
    const message: VoteMessage = {
      type: 'vote',
      option
    };
    
    socket.send(JSON.stringify(message));
    hasVoted = true;
    
    // Store vote in localStorage to prevent multiple votes
    if (browser) {
      localStorage.setItem(`voted_${data.pollId}`, 'true');
    }
  }
  
  function copyPollLink() {
    if (browser) {
      navigator.clipboard.writeText(window.location.href);
      alert('Poll link copied to clipboard!');
    }
  }
  
  onMount(() =&gt; {
    connectToPartyKit();
    
    // Check if user has already voted
    if (browser) {
      hasVoted = localStorage.getItem(`voted_${data.pollId}`) === 'true';
    }
  });
  
  onDestroy(() =&gt; {
    if (socket) {
      socket.close();
    }
  });
&lt;/script&gt;

&lt;svelte:head&gt;
  &lt;title&gt;{poll.title} - Poll&lt;/title&gt;
&lt;/svelte:head&gt;

&lt;main class="container"&gt;
  &lt;div class="poll-header"&gt;
    &lt;h1&gt;{poll.title}&lt;/h1&gt;
    &lt;button class="share-btn" on:click={copyPollLink}&gt;
      📋 Copy Link
    &lt;/button&gt;
  &lt;/div&gt;
  
  {#if connecting}
    &lt;div class="status"&gt;Connecting to live updates...&lt;/div&gt;
  {/if}
  
  &lt;div class="poll-stats"&gt;
    &lt;span class="vote-count"&gt;{totalVotes} vote{totalVotes !== 1 ? 's' : ''}&lt;/span&gt;
    {#if hasVoted}
      &lt;span class="voted-indicator"&gt;✓ You voted&lt;/span&gt;
    {/if}
  &lt;/div&gt;
  
  &lt;div class="options"&gt;
    {#each optionStats as { option, votes, percentage }}
      &lt;div class="option"&gt;
        &lt;button 
          class="option-btn"
          class:voted={hasVoted}
          on:click={() =&gt; vote(option)}
          disabled={hasVoted || connecting}
        &gt;
          &lt;div class="option-content"&gt;
            &lt;span class="option-text"&gt;{option}&lt;/span&gt;
            &lt;span class="option-votes"&gt;{votes}&lt;/span&gt;
          &lt;/div&gt;
          
          {#if totalVotes &gt; 0}
            &lt;div class="progress-bar"&gt;
              &lt;div 
                class="progress-fill" 
                style="width: {percentage}%"
              &gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;span class="percentage"&gt;{percentage.toFixed(1)}%&lt;/span&gt;
          {/if}
        &lt;/button&gt;
      &lt;/div&gt;
    {/each}
  &lt;/div&gt;
  
  {#if !hasVoted && !connecting}
    &lt;p class="instruction"&gt;Click an option to vote!&lt;/p&gt;
  {/if}
  
  &lt;div class="poll-footer"&gt;
    &lt;a href="/" class="create-new-btn"&gt;Create New Poll&lt;/a&gt;
  &lt;/div&gt;
&lt;/main&gt;

&lt;style&gt;
  .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  
  .poll-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  h1 {
    color: #333;
    margin: 0;
    flex: 1;
    min-width: 200px;
  }
  
  .share-btn {
    background: #10b981;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .share-btn:hover {
    background: #059669;
  }
  
  .status {
    text-align: center;
    color: #6b7280;
    margin-bottom: 1rem;
    font-style: italic;
  }
  
  .poll-stats {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 8px;
  }
  
  .vote-count {
    font-weight: 600;
    color: #374151;
  }
  
  .voted-indicator {
    color: #10b981;
    font-weight: 600;
  }
  
  .options {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
  }
  
  .option {
    position: relative;
  }
  
  .option-btn {
    width: 100%;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  
  .option-btn:hover:not(:disabled) {
    border-color: #4f46e5;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
  }
  
  .option-btn:disabled {
    cursor: not-allowed;
  }
  
  .option-btn.voted {
    border-color: #d1d5db;
    background: #f9fafb;
  }
  
  .option-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 2;
  }
  
  .option-text {
    font-size: 1.1rem;
    font-weight: 500;
    color: #374151;
  }
  
  .option-votes {
    font-weight: 600;
    color: #6b7280;
  }
  
  .progress-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: #e5e7eb;
    border-radius: 0 0 10px 10px;
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4f46e5, #7c3aed);
    border-radius: 0 0 10px 10px;
    transition: width 0.5s ease;
  }
  
  .percentage {
    position: absolute;
    top: 0.5rem;
    right: 1.5rem;
    font-size: 0.9rem;
    color: #6b7280;
    font-weight: 600;
  }
  
  .instruction {
    text-align: center;
    color: #6b7280;
    font-style: italic;
    margin-bottom: 2rem;
  }
  
  .poll-footer {
    text-align: center;
    padding-top: 2rem;
    border-top: 1px solid #e5e7eb;
  }
  
  .create-new-btn {
    background: #f3f4f6;
    color: #374151;
    text-decoration: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    transition: background-color 0.2s;
  }
  
  .create-new-btn:hover {
    background: #e5e7eb;
  }
  
  @media (max-width: 640px) {
    .container {
      padding: 1rem;
    }
    
    .poll-header {
      flex-direction: column;
      align-items: stretch;
    }
    
    .poll-stats {
      flex-direction: column;
      gap: 0.5rem;
      text-align: center;
    }
    
    .option-btn {
      padding: 1rem;
    }
    
    .percentage {
      position: static;
      margin-top: 0.5rem;
      display: block;
    }
  }
&lt;/style&gt;</code></pre>

    <h2>Real-time Features</h2>
    <p>This component includes powerful real-time functionality:</p>

    <h3>⚡ WebSocket Connection</h3>
    <ul>
        <li><strong>Auto-connect:</strong> Establishes WebSocket connection on page load</li>
        <li><strong>Auto-reconnect:</strong> Reconnects automatically if connection drops</li>
        <li><strong>Live updates:</strong> Receives vote updates in real-time</li>
    </ul>

    <h3>🗳️ Voting System</h3>
    <ul>
        <li><strong>One vote per user:</strong> Uses localStorage to prevent multiple votes</li>
        <li><strong>Instant feedback:</strong> UI updates immediately after voting</li>
        <li><strong>Visual progress:</strong> Shows vote percentages and counts</li>
    </ul>

    <h3>📊 Dynamic Calculations</h3>
    <ul>
        <li><strong>Reactive totals:</strong> Vote counts update automatically</li>
        <li><strong>Percentage bars:</strong> Visual representation of vote distribution</li>
        <li><strong>Real-time stats:</strong> Live vote counts across all options</li>
    </ul>

                    <div class="success">
                        <strong>✅ Real-time Magic!</strong> Your poll page now updates instantly as votes come in. Next, we'll add the
                        beautiful UI and run the complete application.
                    </div>

                    <!-- Navigation -->
                    <div class="navigation">
                        <button class="nav-btn secondary" onclick="previousStep()">← Previous</button>
                        <span>Step 8 of 10</span>
                        <button class="nav-btn" onclick="nextStep()">Next →</button>
                    </div>
                </div>

                <!-- Step 8: Running the App -->
                <div class="step-content" id="step-8">
    <div class="step-number">8</div>
    <h1>Step 8: Running the App</h1>
    <p>Time to bring everything together and run your real-time polling app!</p>

    <h2>Update Package Scripts</h2>
    <p>Add these scripts to your <code>package.json</code>:</p>
    <pre><code>{
  "scripts": {
    "dev": "npm run dev:party &amp; npm run dev:sveltekit",
    "dev:party": "partykit dev",
    "dev:sveltekit": "vite dev",
    "build": "vite build",
    "preview": "vite preview",
    "party:deploy": "partykit deploy"
  }
}</code></pre>

    <h2>Start Your Development Servers</h2>
    <p>Run both servers simultaneously:</p>
    <pre><code>npm run dev</code></pre>

    <p>This command starts:</p>
    <ul>
        <li><strong>PartyKit server</strong> on <code>http://127.0.0.1:1999</code></li>
        <li><strong>SvelteKit app</strong> on <code>http://localhost:5173</code></li>
    </ul>

    <h2>Test Your Application</h2>
    <p>Follow these steps to test all functionality:</p>

    <h3>1. Create a Poll</h3>
    <ol>
        <li>Go to <code>http://localhost:5173</code></li>
        <li>Enter a poll title (e.g., "What's your favorite color?")</li>
        <li>Add poll options (e.g., "Red", "Blue", "Green")</li>
        <li>Click "Create Poll"</li>
    </ol>

    <h3>2. Test Real-time Voting</h3>
    <ol>
        <li>Copy the poll URL from your browser</li>
        <li>Open the poll in multiple browser tabs or windows</li>
        <li>Vote in one tab</li>
        <li>Watch the results update instantly in other tabs! ⚡</li>
    </ol>

    <h3>3. Test Sharing</h3>
    <ol>
        <li>Click the "Copy Link" button on any poll</li>
        <li>Share the link with friends or open in incognito mode</li>
        <li>Vote from different devices/browsers</li>
        <li>See votes update across all connected clients</li>
    </ol>

    <div class="success">
        <strong>🎉 It's Working!</strong> You now have a fully functional real-time polling app. Users can create polls,
        vote, and see results update instantly across all devices.
    </div>

    <h2>Troubleshooting</h2>
    <p>If you encounter issues:</p>

    <h3>Environment Variables</h3>
    <ul>
        <li>Ensure your <code>.env</code> file is in the project root</li>
        <li>Restart servers after changing environment variables</li>
    </ul>

    <h3>Connection Issues</h3>
    <ul>
        <li>Check that both servers are running</li>
        <li>Look for error messages in browser console</li>
        <li>Verify PartyKit server responds at <code>http://127.0.0.1:1999</code></li>
    </ul>

                    <div class="warning">
                        <strong>💡 Pro Tip:</strong> Open browser dev tools (F12) to see WebSocket connections and debug any issues. The
                        Network tab shows WebSocket traffic.
                    </div>

                    <!-- Navigation -->
                    <div class="navigation">
                        <button class="nav-btn secondary" onclick="previousStep()">← Previous</button>
                        <span>Step 9 of 10</span>
                        <button class="nav-btn" onclick="nextStep()">Next →</button>
                    </div>
                </div>

                <!-- Step 9: Deployment -->
                <div class="step-content" id="step-9">
    <div class="step-number">9</div>
    <h1>Step 9: Deployment</h1>
    <p>Ready to share your polling app with the world? Let's deploy it to production!</p>

    <h2>Deploy PartyKit Server</h2>
    <p>First, deploy your PartyKit server:</p>
    <pre><code>npx partykit deploy</code></pre>

    <p>This will:</p>
    <ul>
        <li>Create a PartyKit account if you don't have one</li>
        <li>Deploy your server to a global edge network</li>
        <li>Give you a URL like <code>your-project.your-username.partykit.dev</code></li>
    </ul>

    <h2>Update Environment Variables</h2>
    <p>After deployment, update your <code>.env</code> file for production:</p>
    <pre><code># Development
PARTYKIT_URL=http://127.0.0.1:1999
PUBLIC_PARTYKIT_HOST=127.0.0.1:1999

# Production
PARTYKIT_URL=https://your-project.your-username.partykit.dev
PUBLIC_PARTYKIT_HOST=your-project.your-username.partykit.dev</code></pre>

    <h2>Deploy SvelteKit App</h2>
    <p>You can deploy your SvelteKit app to various platforms:</p>

    <h3>🚀 Vercel (Recommended)</h3>
    <pre><code># Install Vercel CLI
npm i -g vercel

# Deploy
vercel</code></pre>

    <h3>🌐 Netlify</h3>
    <pre><code># Install Netlify CLI
npm i -g netlify-cli

# Build and deploy
npm run build
netlify deploy --prod --dir build</code></pre>

    <h3>🐳 Railway</h3>
    <pre><code># Install Railway CLI
npm i -g @railway/cli

# Login and deploy
railway login
railway deploy</code></pre>

    <h2>Set Production Environment Variables</h2>
    <p>In your deployment platform, set these environment variables:</p>
    <pre><code>PUBLIC_PARTYKIT_HOST=your-project.your-username.partykit.dev
PARTYKIT_URL=https://your-project.your-username.partykit.dev</code></pre>

    <h3>For Vercel:</h3>
    <ol>
        <li>Go to your project dashboard</li>
        <li>Click "Settings" → "Environment Variables"</li>
        <li>Add the variables above</li>
        <li>Redeploy your application</li>
    </ol>

    <h2>🎉 Congratulations!</h2>
    <div class="success">
        <strong>You did it!</strong> You've successfully built and deployed a real-time multiplayer polling application
        using SvelteKit and PartyKit.
    </div>

    <h2>Next Steps</h2>
    <p>Now that you have a solid foundation, consider adding:</p>
    <ul>
        <li><strong>User Authentication:</strong> Add accounts with Auth0 or similar</li>
        <li><strong>Poll Expiration:</strong> Set time limits on polls</li>
        <li><strong>Advanced Analytics:</strong> Track participation rates and trends</li>
        <li><strong>Custom Themes:</strong> Let users style their polls</li>
        <li><strong>Comments System:</strong> Add real-time comments to polls</li>
        <li><strong>Admin Dashboard:</strong> Manage polls and view statistics</li>
    </ul>

    <h2>Share Your Creation</h2>
    <p>We'd love to see what you've built! Share your polling app and let others experience real-time collaboration in
        action.</p>

                    <div class="success">
                        <strong>🌟 Thank you for following this tutorial!</strong> You've learned valuable skills in real-time web
                        development that you can apply to many other projects.
                    </div>

                    <!-- Navigation -->
                    <div class="navigation">
                        <button class="nav-btn secondary" onclick="previousStep()">← Previous</button>
                        <span>Step 10 of 10</span>
                        <button class="nav-btn" onclick="nextStep()">Complete ✓</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentStep = 0;
        const totalSteps = 9; // 0-9 (10 steps total)

        function showStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(step => {
                step.classList.remove('active');
            });

            // Show current step
            document.getElementById(`step-${stepNumber}`).classList.add('active');

            // Update navigation
            document.querySelectorAll('.step-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-step="${stepNumber}"]`).classList.add('active');

            currentStep = stepNumber;

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                showStep(currentStep + 1);
            }
        }

        function previousStep() {
            if (currentStep > 0) {
                showStep(currentStep - 1);
            }
        }

        // Handle step navigation clicks
        document.querySelectorAll('.step-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const stepNumber = parseInt(e.currentTarget.dataset.step);
                showStep(stepNumber);
            });
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                previousStep();
            } else if (e.key === 'ArrowRight') {
                nextStep();
            }
        });

        // Initialize
        showStep(0);
    </script>
</body>

</html>